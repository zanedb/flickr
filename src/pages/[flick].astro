---
import { Image } from 'astro:assets'
import Layout from '../layouts/Layout.astro'
import Header from '../components/Header.astro'

export function getStaticPaths() {
  const flicks = import.meta.glob('../assets/flicks/*.{jpeg,jpg,png}', {
    eager: false,
  })

  const paths = Object.keys(flicks).map((f) => ({
    params: {
      flick: f.replace('../assets/flicks/', ''),
    },
  }))

  return paths
}

const { flick } = Astro.params
const src = import(`../assets/flicks/${flick.slice(0, -4)}.jpg`)
---

<Layout>
  <Header />
  <figure
    class="flex justify-center h-[calc(100%-8rem)] w-full"
    transition:name={flick}
  >
    <div class="absolute top-0 left-0 w-[100vw] h-[100vh] -z-10" id="bg"></div>
    <Image
      src={src}
      alt="Flick"
      class="border-2 md:border-4 md:border-x-6 border-pink-500 m-4 max-h-full w-auto"
    />
  </figure>
  <script>
    // If corresponding ambience sfx with same title as {flick} exists, play it on load
    let flick = window.location.pathname.replace(/\.[^/.]+$/, '').substring(1)
    let sfx = new Audio()
    import { navigate } from 'astro:transitions/client'

    const sfxTrigger = () => {
      // only trigger sound on images
      if (window.location.pathname.slice(-4) === '.jpg') {
        console.log('IMAGE LOADED')
        flick = window.location.pathname.replace(/\.[^/.]+$/, '').substring(1)
        console.log(`PLAYING /sfx/ambience/${flick}.mp3`)

        sfx = new Audio(`/sfx/ambience/${flick}.mp3`)
        sfx.volume = 0.5
        // sfx.loop = true
        sfx.play()
      } else {
        console.log('UNLOADING SFX')

        sfx.pause()
        sfx.currentTime = 0
        flick = ''
      }
    }

    document.addEventListener('astro:page-load', () => {
      sfxTrigger()

      const bg = document.getElementById('bg')
      if (bg) {
        bg.addEventListener('click', function () {
          const click = new Audio(`/sfx/click.mp3`)
          navigate('/')
          click.volume = 0.7
          click.play()
        })
      }
    })
  </script>
</Layout>
